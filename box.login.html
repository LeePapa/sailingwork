<script type="text/javascript">
$(function() {
    var box = $.FloatBox($("#id_setuser_box_1413132417")).Open();
    window.LoginBox = box;

    var Login = new function(){
        var $doing = $("#id_setuser_box_1413132417 .doing");
        var $username = $("#id_setuser_box_1413132417 .username");
        var $password = $("#id_setuser_box_1413132417 .password");

        function DoLogin()
        {
            $doing.html("正在登录...").show().SetPromptStyle();
            Util.EncSubmit("login_save.php",
                {
                    login        : 1,
                    username     : $username.val().trim(),
                    password_md5 : $.md5($password.val().trim())
                },
                function(resp){
                    console.log("resp.ret:" + resp.ret);
                    if(resp.ret < 0)
                    {
                        if(-10021 == resp.ret)  // USER_LOGINED
                        {
                            $doing.html("用户["+resp.data.username+"]已登录过，不能重复登录.")
                                  .show().SetPromptStyle().fadeOut(2000, function(){
                                        JumpTo();
                            });
                        }
                        else
                        {
                            $doing.html(errcode.toString(resp.ret)).show().SetErrStyle();
                        }
                        return;
                    }
                    if(resp.data)
                    {
                        window.Store.SetGlobalData("userid", resp.data.userid);
                        window.Store.SetGlobalData("username", resp.data.username);
                        //$.cookie("userid", resp.data.userid, {expires:7, path:'/'});
                        $doing.html("登录成功").SetOkStyle().fadeOut(function(){
                            JumpTo();
                        });
                    }
                }
            );
        }

        function JumpTo()
        {
            if($.query.get("debug"))
            {
                return;
            }
            var pagename = Util.GetPagename();
            var username = window.Store.GetGlobalData("username");
            if("login.php" == pagename)
            {
                if("admin" == username)
                {
                    location.href = "admin.php";
                }
                else
                {
                    location.href = "menu.php";
                }
            }
            box.Close();
        }

        function GetPrompt()
        {
            Util.EncSubmit("get_passwd_prompt.php",
                {
                    "type"     :"user",
                    "username" :$username.val().trim()
                },
                function(resp){
                    if(resp.ret < 0)
                    {
                        $doing.html(errcode.toString(resp.ret)).show().SetErrStyle();
                        return;
                    }
                    $doing.html(resp.data.passwd_prompt||"[未设置]").SetOkStyle();
            });
        }

        $("#id_setuser_box_1413132417 .ok").click(function(){
            DoLogin();
        });

        $("#id_setuser_box_1413132417 .prompt").click(function(){
            GetPrompt();
        });

        $("#id_setuser_box_1413132417 .password").Enter(function(){
            DoLogin();
        })

        DoLogin();
        console.log("end");
    };
});
</script>
<body>

<style type="text/css">
#id_setuser_box_1413132417 {
    padding: 3px;
    background-color: white;
}
#id_setuser_box_1413132417 .username,
#id_setuser_box_1413132417 .password {
    width: 230px;
    margin: 3px;
    height: 30px;
    margin-top: 8px;
    font-size: 24px;
}
#id_setuser_box_1413132417 .doing {
    float:left;
    font-style:italic;
    margin:5px 0 0 0;
}
</style>
<div id="id_setuser_box_1413132417" class="popup_box">
<fieldset>
<legend>登录</legend>


<div style="display:block; width:343px;">
    <div>
    　用户：<input class="username" /><br>
    　密码：<input type="password" class="password" /><br>
    </div>

    <div style="text-align:right; border:0px dashed #000; margin-top:10px;">
        <span class="doing"></span>
        <input type="button" class="ok" value="确定" />
        <input type="button" class="prompt" value="提示" />
    </div>
</div>


</fieldset>
</div>

</body>
